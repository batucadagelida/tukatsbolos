<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tukats - Gestió de Batucada</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel Standalone -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #DCF23A; margin: 0; padding: 0; }
        
        .custom-scrollbar { -webkit-overflow-scrolling: touch; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .person-selected {
            outline: 3px solid #16a34a;
            outline-offset: 2px;
            background-color: white !important;
            z-index: 10;
        }

        /* Efecte 3D Botons Pestanyes */
        .btn-3d-raised {
            box-shadow: 0 4px 0 0 rgba(0,0,0,0.2);
            transform: translateY(-2px);
            transition: all 0.1s ease;
        }
        .btn-3d-pushed {
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.2);
            transform: translateY(2px);
            background-color: rgba(0,0,0,0.05);
        }

        /* Pestanya de data */
        .date-tab {
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,0.15);
        }

        html, body, #root {
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        .overflow-y-auto, .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const productionConfig = {
            apiKey: "AIzaSyAbqfNeh1p-jGp0vGl6K85N-SJSi7DPwn0",
            authDomain: "tukatsbolos.firebaseapp.com",
            projectId: "tukatsbolos",
            storageBucket: "tukatsbolos.firebasestorage.app",
            messagingSenderId: "74618830888",
            appId: "1:74618830888:web:a8e08918d802ab1498751d"
        };

        window.PROD_APP_ID = "tukats-batucada-v1"; 
        let firebaseConfig = productionConfig;
        
        if ((!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("AQUI")) && typeof window.__firebase_config !== 'undefined' && window.__firebase_config) {
            try {
                firebaseConfig = JSON.parse(window.__firebase_config);
                window.PROD_APP_ID = window.__app_id || window.PROD_APP_ID;
            } catch (e) { console.warn("Error config Canvas"); }
        }

        if (firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("AQUI")) {
            const app = initializeApp(firebaseConfig);
            window.FirebaseApp = {
                auth: getAuth(app),
                db: getFirestore(app),
                signInAnonymously,
                signInWithCustomToken,
                onAuthStateChanged,
                doc,
                setDoc,
                onSnapshot,
                updateDoc,
                collection,
                deleteDoc,
                addDoc,
                initialized: true
            };
        } else { window.FirebaseApp = { initialized: false }; }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icon = ({ name, size = 16, className = "" }) => {
            const icons = {
                plus: <path d="M12 5v14M5 12h14" />,
                'log-out': <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />,
                calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></>,
                'map-pin': <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>,
                clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
                hourglass: <><path d="M5 2h14M5 22h14M15 2v5l-3 3-3-3V2M9 22v-5l3-3 3 3v5"/></>,
                key: <><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.778-7.778Zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3-3.5 3.5Z"/></>,
                eye: <><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>,
                info: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>,
                car: <><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></>,
                utensils: <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" />,
                trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6" />,
                edit: <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />,
                settings: <><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>
            };
            return (
                <svg viewBox="0 0 24 24" width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || null}
                </svg>
            );
        };

        const ALL_PEOPLE = ["Jesus", "Merche", "Txis", "Josep", "Nacho", "Mon", "Claudia", "Toñi", "Alba", "Viñet", "Evelyn", "Dahna", "DavidB", "David", "Xavi", "Johny", "Valentin", "JosepA", "Merce", "Lorena", "Bruna", "Emily", "Valentina", "Carmen", "Maria", "Marta", "Paula", "Ona", "Aina", "Lluis", "Ernest"].sort();
        const INSTRUMENTS = ["1a", "2a", "3a", "Caixa", "Timba", "Xapa", "Tamborin", "Repe"];
        const MESOS = ["Gener", "Febrer", "Març", "Abril", "Maig", "Juny", "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre"];

        function App() {
            const [fb, setFb] = useState(null);
            const [user, setUser] = useState(null);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [isAdminAuth, setIsAdminAuth] = useState(false);
            const [isAdminMode, setIsAdminMode] = useState(false);
            const [passwordInput, setPasswordInput] = useState("");
            const [bolos, setBolos] = useState([]);
            const [selectedBolo, setSelectedBolo] = useState(null);
            const [activeTab, setActiveTab] = useState('instruments');
            
            const [attendance, setAttendance] = useState({});
            const [assignments, setAssignments] = useState({});
            const [carData, setCarData] = useState(Array.from({length: 8}, (_, i) => ({ id: i+1, driver: null, capacity: 4, passengers: [] })));
            const [foodData, setFoodData] = useState({ standard: [], vegan: [], glutenFree: [], glutenFreeVegan: [] });
            const [boloSettings, setBoloSettings] = useState({ carsEnabled: false, foodEnabled: false });
            const [carCosts, setCarCosts] = useState({ enabled: false, distancia: "", consum: "6.5", preuLitre: "1.40", proposta: "" });
            
            const [settings, setSettings] = useState({ userPass: "TUKATS", adminPass: "ADMIN" });
            const [isLoading, setIsLoading] = useState(true);
            const [personToMove, setPersonToMove] = useState(null);

            const [showBoloModal, setShowBoloModal] = useState(false);
            const [showConfigModal, setShowConfigModal] = useState(false);
            const [editingBoloData, setEditingBoloData] = useState(null);

            useEffect(() => {
                const interval = setInterval(() => {
                    if (window.FirebaseApp) { setFb(window.FirebaseApp); clearInterval(interval); }
                }, 100);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                if (!fb) return;
                const initAuth = async () => {
                    try {
                        if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                            await fb.signInWithCustomToken(fb.auth, window.__initial_auth_token).catch(() => fb.signInAnonymously(fb.auth));
                        } else { 
                            await fb.signInAnonymously(fb.auth); 
                        }
                    } catch (err) {
                        console.error("Auth init failed, retrying anonymous...");
                        await fb.signInAnonymously(fb.auth);
                    }
                };
                initAuth();
                return fb.onAuthStateChanged(fb.auth, setUser);
            }, [fb]);

            useEffect(() => {
                if (!user || !fb) return;
                const appId = window.PROD_APP_ID;
                const unsubSettings = fb.onSnapshot(fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'app_settings', 'config'), snap => {
                    if (snap.exists()) setSettings(snap.data());
                });
                const unsubBolos = fb.onSnapshot(fb.collection(fb.db, 'artifacts', appId, 'public', 'data', 'bolos'), snap => {
                    setBolos(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => { unsubSettings(); unsubBolos(); };
            }, [user, fb]);

            useEffect(() => {
                if (!user || !selectedBolo || !fb) return;
                setIsLoading(true);
                const appId = window.PROD_APP_ID;
                const unsub = fb.onSnapshot(fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'bolos_attendance', selectedBolo.id), snap => {
                    if (snap.exists()) {
                        const d = snap.data();
                        setAttendance(d.attendance || {});
                        setAssignments(d.assignments || {});
                        setCarData(d.carData || Array.from({length: 8}, (_, i) => ({ id: i+1, driver: null, capacity: 4, passengers: [] })));
                        
                        const fd = d.foodData || {};
                        setFoodData({
                            standard: fd.standard || [],
                            vegan: fd.vegan || [],
                            glutenFree: fd.glutenFree || [],
                            glutenFreeVegan: fd.glutenFreeVegan || []
                        });
                        
                        setBoloSettings(d.boloSettings || { carsEnabled: false, foodEnabled: false });
                        
                        const cc = d.carCosts || {};
                        setCarCosts({
                            enabled: cc.enabled || false,
                            distancia: cc.distancia !== undefined ? cc.distancia : "",
                            consum: cc.consum !== undefined ? cc.consum : "6.5",
                            preuLitre: cc.preuLitre !== undefined ? cc.preuLitre : "1.40",
                            proposta: cc.proposta !== undefined ? cc.proposta : ""
                        });
                    }
                    setIsLoading(false);
                }, (err) => { console.error(err); setIsLoading(false); });
                return () => unsub();
            }, [user, selectedBolo, fb]);

            const syncBoloData = async (updates) => {
                if (!user || !selectedBolo || !fb) return;
                const appId = window.PROD_APP_ID;
                const docRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'bolos_attendance', selectedBolo.id);
                const boloRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'bolos', selectedBolo.id);
                
                const finalAtt = updates.attendance || attendance;
                const finalAss = updates.assignments || assignments;
                const finalSettings = updates.boloSettings || boloSettings;
                const finalCarCosts = updates.carCosts || carCosts;

                const counts = {
                    memberCount: Object.values(finalAss).filter(v => v !== null).length,
                    declinedCount: Object.values(finalAtt).filter(v => v === 'red').length,
                    watchingCount: Object.values(finalAtt).filter(v => v === 'blue').length,
                };
                counts.pendingCount = ALL_PEOPLE.length - counts.memberCount - counts.declinedCount - counts.watchingCount;

                try {
                    await fb.updateDoc(docRef, { 
                        attendance: finalAtt, 
                        assignments: finalAss,
                        carData: updates.carData || carData,
                        foodData: updates.foodData || foodData,
                        boloSettings: finalSettings,
                        carCosts: finalCarCosts
                    });
                    await fb.updateDoc(boloRef, {
                        ...counts,
                        carsEnabled: !!finalSettings.carsEnabled,
                        foodEnabled: !!finalSettings.foodEnabled
                    });
                } catch (e) { console.error(e); }
            };

            const getBoloDateTime = (b) => {
                if (!b.fecha) return new Date(0);
                const [y, m, d] = b.fecha.split('-').map(Number);
                const [hh, mm] = (b.hora || "00:00").split(':').map(Number);
                return new Date(y, m - 1, d, hh, mm);
            };

            const esPasado = (b) => {
                const fechaBolo = getBoloDateTime(b);
                return fechaBolo < new Date();
            };

            const getFormattedDateBadge = (fechaStr) => {
                if (!fechaStr) return { day: "?", month: "?" };
                const [y, m, d] = fechaStr.split('-').map(Number);
                return {
                    day: d,
                    month: MESOS[m - 1]
                };
            };

            const handleLogin = (e) => {
                e.preventDefault();
                const target = isAdminMode ? settings.adminPass : settings.userPass;
                if (passwordInput === target) {
                    setIsLoggedIn(true);
                    setIsAdminAuth(isAdminMode);
                    setPasswordInput("");
                }
            };

            const handleDeleteBolo = async (id, e) => {
                e.stopPropagation();
                if (!confirm("Segur que vols eliminar aquest bolo?")) return;
                const appId = window.PROD_APP_ID;
                try {
                    await fb.deleteDoc(fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'bolos', id));
                    await fb.deleteDoc(fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'bolos_attendance', id));
                } catch (err) { console.error(err); }
            };

            const handleSaveBolo = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = {
                    nombre: formData.get('nombre'),
                    fecha: formData.get('fecha'),
                    hora: formData.get('hora'),
                    duracion: formData.get('duracion'),
                    lugar: formData.get('lugar')
                };

                const appId = window.PROD_APP_ID;
                try {
                    if (editingBoloData) {
                        await fb.updateDoc(fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'bolos', editingBoloData.id), data);
                    } else {
                        const docRef = await fb.addDoc(fb.collection(fb.db, 'artifacts', appId, 'public', 'data', 'bolos'), {
                            ...data,
                            memberCount: 0, pendingCount: ALL_PEOPLE.length, declinedCount: 0, watchingCount: 0,
                            info: "", carsEnabled: false, foodEnabled: false
                        });
                        await fb.setDoc(fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'bolos_attendance', docRef.id), {
                            attendance: {}, assignments: {}, 
                            carData: Array.from({length: 8}, (_, i) => ({ id: i+1, driver: null, capacity: 4, passengers: [] })),
                            foodData: { standard: [], vegan: [], glutenFree: [], glutenFreeVegan: [] },
                            boloSettings: { carsEnabled: false, foodEnabled: false },
                            carCosts: { enabled: false, distancia: "", consum: "6.5", preuLitre: "1.40", proposta: "" }
                        });
                    }
                    setShowBoloModal(false);
                    setEditingBoloData(null);
                } catch (err) { console.error(err); }
            };

            const handleUpdatePasswords = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const appId = window.PROD_APP_ID;
                try {
                    await fb.updateDoc(fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'app_settings', 'config'), {
                        userPass: formData.get('userPass'),
                        adminPass: formData.get('adminPass')
                    });
                    setShowConfigModal(false);
                } catch (err) { console.error(err); }
            };

            const availablePeople = useMemo(() => {
                return ALL_PEOPLE.filter(p => attendance[p] === 'green' || attendance[p] === 'blue' || assignments[p] !== null);
            }, [attendance, assignments]);

            const renderBoloCard = (b) => {
                const hasInfo = b.info && b.info.trim().length > 0;
                const pasado = esPasado(b);
                const responsiveIconSize = 15;
                const { day, month } = getFormattedDateBadge(b.fecha);

                return (
                    <div key={b.id} onClick={() => { setSelectedBolo(b); setActiveTab('instruments'); }} 
                         className={`p-4 bg-white/70 rounded-3xl flex flex-col gap-2 shadow-md hover:border-green-500 border-2 border-transparent transition-all cursor-pointer relative group mt-4 mb-2 ${pasado ? 'opacity-50 grayscale-[20%]' : ''}`}>
                        
                        {/* Pestanya de Data que sobresurt actualitzada amb el color corporatiu */}
                        <div className={`absolute -top-4 -right-2 p-2 px-4 rounded-xl flex flex-col items-center justify-center date-tab z-20 ${pasado ? 'bg-gray-500 text-white' : 'bg-[#DCF23A] text-black border border-black/5'}`}>
                            <span className="text-xl font-black leading-none">{day}</span>
                            <span className="text-[10px] font-black uppercase tracking-tight leading-none mt-1 opacity-90">{month}</span>
                        </div>

                        {isAdminAuth && (
                            <div className="absolute -bottom-2 -left-2 flex gap-1 z-30">
                                <button onClick={(e) => { e.stopPropagation(); setEditingBoloData(b); setShowBoloModal(true); }} className="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors shadow-sm">
                                    <Icon name="edit" size={14}/>
                                </button>
                                <button onClick={(e) => handleDeleteBolo(b.id, e)} className="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors shadow-sm">
                                    <Icon name="trash" size={14}/>
                                </button>
                            </div>
                        )}

                        <h4 className="text-2xl font-black italic text-green-900 leading-none mb-0.5 pr-20">{b.nombre}</h4>
                        
                        <div className="flex flex-col gap-0.5 text-[15px] font-black opacity-70 tracking-normal">
                            <div className="flex flex-wrap gap-x-4 gap-y-0.5 leading-tight">
                                <span className="flex items-center gap-1 uppercase"><Icon name="clock" size={15}/> {b.hora}</span>
                                {b.duracion && (
                                    <span className="flex items-center gap-1"><Icon name="hourglass" size={15}/> {b.duracion}</span>
                                )}
                            </div>
                            <span className="flex items-center gap-1 leading-tight uppercase"><Icon name="map-pin" size={15}/> {b.lugar}</span>
                        </div>
                        
                        <div className="flex flex-col gap-1 mt-1">
                            <div className="flex gap-1 w-full">
                                <div className="flex-1 bg-green-100 text-green-800 p-1 md:p-1.5 rounded-xl text-center font-black text-[13px] uppercase">{b.memberCount || 0} OK</div>
                                <div className="flex-1 bg-orange-100 text-orange-800 p-1 md:p-1.5 rounded-xl text-center font-black text-[13px] uppercase">{b.pendingCount || 0} ?</div>
                                <div className="flex-1 bg-red-100 text-red-800 p-1 md:p-1.5 rounded-xl text-center font-black text-[13px] uppercase">{b.declinedCount || 0} NO</div>
                                <div className="flex-1 bg-blue-100 text-blue-800 p-1 md:p-1.5 rounded-xl text-center font-black text-[13px] uppercase flex items-center justify-center gap-1">
                                    <Icon name="eye" size={responsiveIconSize}/> {b.watchingCount || 0}
                                </div>
                            </div>
                            
                            <div className="flex gap-1 w-full">
                                <div className={`flex-1 p-1 md:p-1.5 rounded-xl text-center font-black text-[13px] uppercase flex items-center justify-center gap-1 transition-all ${hasInfo ? 'bg-blue-600 text-white shadow-md' : 'bg-blue-600/5 text-blue-900/10'}`}>
                                    <Icon name="info" size={responsiveIconSize}/> INFO
                                </div>
                                <div className={`flex-1 p-1 md:p-1.5 rounded-xl text-center font-black text-[13px] uppercase flex items-center justify-center gap-1 transition-all ${b.carsEnabled ? 'bg-amber-800 text-white shadow-md' : 'bg-amber-800/5 text-amber-900/10'}`}>
                                    <Icon name="car" size={responsiveIconSize}/> COTXES
                                </div>
                                <div className={`flex-1 p-1 md:p-1.5 rounded-xl text-center font-black text-[13px] uppercase flex items-center justify-center gap-1 transition-all ${b.foodEnabled ? 'bg-purple-600 text-white shadow-md' : 'bg-purple-600/5 text-purple-900/10'}`}>
                                    <Icon name="utensils" size={responsiveIconSize}/> MENJAR
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderBoloModal = () => (
                <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm overflow-y-auto">
                    <div className="bg-white w-full max-w-lg rounded-[2.5rem] p-8 shadow-2xl relative">
                        <h3 className="text-3xl font-black uppercase italic mb-6 text-green-900">{editingBoloData ? 'Editar Bolo' : 'Nou Bolo'}</h3>
                        <form onSubmit={handleSaveBolo} className="space-y-4">
                            <div>
                                <label className="block text-xs font-black uppercase opacity-40 mb-1">Nom del Bolo</label>
                                <input name="nombre" defaultValue={editingBoloData?.nombre} className="w-full p-4 bg-gray-100 rounded-2xl font-bold" required />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-black uppercase opacity-40 mb-1">Data</label>
                                    <input name="fecha" type="date" defaultValue={editingBoloData?.fecha} className="w-full p-4 bg-gray-100 rounded-2xl font-bold" required />
                                </div>
                                <div>
                                    <label className="block text-xs font-black uppercase opacity-40 mb-1">Hora</label>
                                    <input name="hora" type="time" defaultValue={editingBoloData?.hora} className="w-full p-4 bg-gray-100 rounded-2xl font-bold" required />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-black uppercase opacity-40 mb-1">Durada</label>
                                    <input name="duracion" placeholder="ex: 1h 30m" defaultValue={editingBoloData?.duracion} className="w-full p-4 bg-gray-100 rounded-2xl font-bold" />
                                </div>
                                <div>
                                    <label className="block text-xs font-black uppercase opacity-40 mb-1">Lloc</label>
                                    <input name="lugar" defaultValue={editingBoloData?.lugar} className="w-full p-4 bg-gray-100 rounded-2xl font-bold" required />
                                </div>
                            </div>
                            <div className="flex gap-3 pt-4">
                                <button type="button" onClick={() => { setShowBoloModal(false); setEditingBoloData(null); }} className="flex-1 py-4 bg-gray-200 text-gray-700 font-black rounded-2xl uppercase tracking-widest">Cancel·lar</button>
                                <button type="submit" className="flex-1 py-4 bg-green-600 text-white font-black rounded-2xl uppercase tracking-widest shadow-lg shadow-green-600/20">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );

            const renderConfigModal = () => (
                <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                    <div className="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl">
                        <h3 className="text-3xl font-black uppercase italic mb-6 text-blue-900">Ajustos</h3>
                        <form onSubmit={handleUpdatePasswords} className="space-y-4">
                            <div>
                                <label className="block text-xs font-black uppercase opacity-40 mb-1">Password Usuari</label>
                                <input name="userPass" defaultValue={settings.userPass} className="w-full p-4 bg-gray-100 rounded-2xl font-bold" required />
                            </div>
                            <div>
                                <label className="block text-xs font-black uppercase opacity-40 mb-1">Password Admin</label>
                                <input name="adminPass" defaultValue={settings.adminPass} className="w-full p-4 bg-gray-100 rounded-2xl font-bold" required />
                            </div>
                            <div className="flex gap-3 pt-4">
                                <button type="button" onClick={() => setShowConfigModal(false)} className="flex-1 py-4 bg-gray-200 text-gray-700 font-black rounded-2xl uppercase tracking-widest">Tancar</button>
                                <button type="submit" className="flex-1 py-4 bg-blue-600 text-white font-black rounded-2xl uppercase tracking-widest shadow-lg shadow-blue-600/20">Actualitzar</button>
                            </div>
                        </form>
                    </div>
                </div>
            );

            if (!isLoggedIn) return (
                <div className="h-screen w-screen flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-sm border-t-[10px] border-green-600">
                        <h1 className="text-4xl font-black text-center mb-8 text-green-900 uppercase tracking-tighter italic">Tukats Login</h1>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <div className="flex items-center space-x-3 bg-gray-50 p-4 rounded-2xl border border-gray-100">
                                <input type="checkbox" id="adm" checked={isAdminMode} onChange={e => setIsAdminMode(e.target.checked)} className="w-6 h-6 accent-green-600 cursor-pointer" />
                                <label htmlFor="adm" className="text-sm font-black text-gray-700 cursor-pointer select-none uppercase tracking-tight">Mode Administrador</label>
                            </div>
                            <input type="password" placeholder="Contrasenya" className="w-full p-5 bg-gray-50 border-2 border-transparent rounded-2xl focus:border-green-500 outline-none text-xl font-bold" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} required />
                            <button type="submit" className="w-full bg-green-600 text-white font-black py-5 rounded-2xl hover:bg-green-700 shadow-xl transition-all uppercase tracking-widest text-lg">Entrar</button>
                        </form>
                    </div>
                </div>
            );

            if (!selectedBolo) {
                const sortedBolos = [...bolos].sort((a, b) => getBoloDateTime(a) - getBoloDateTime(b));
                const futureBolos = sortedBolos.filter(b => !esPasado(b));
                const pastBolos = sortedBolos.filter(b => esPasado(b)).reverse();

                return (
                    <div className="h-screen w-screen flex flex-col overflow-hidden text-green-950">
                        <header className="px-6 py-4 bg-white/20 backdrop-blur-md flex justify-between items-center shrink-0 border-b border-white/20">
                            {/* Canvi per incloure el logo a l'esquerra del títol i de la mateixa alçada (1em) */}
                            <div className="flex items-center gap-2 md:gap-3 shrink-0">
                                <img src="./Logo_Quadrat.jpg" alt="Logo Tukats" className="h-[1.2em] w-auto rounded-md mix-blend-multiply" />
                                <h2 className="text-2xl font-black italic tracking-tighter uppercase shrink-0 m-0 leading-none">TUKATS - BOLOS</h2>
                            </div>
                            <div className="flex gap-2">
                                {isAdminAuth && (
                                    <button onClick={() => setShowConfigModal(true)} className="p-3 bg-white/50 text-blue-900 rounded-xl hover:bg-white shadow-sm">
                                        <Icon name="settings" size={20}/>
                                    </button>
                                )}
                                <button onClick={() => setIsLoggedIn(false)} className="bg-red-600 text-white px-4 py-2 rounded-xl font-black flex items-center gap-1.5 hover:bg-red-700 uppercase tracking-tighter shadow-md text-xs shrink-0"><Icon name="log-out" size={14}/> Sortir</button>
                            </div>
                        </header>
                        <main className="flex-1 p-2 md:p-8 flex flex-col items-center overflow-hidden">
                            <div className="w-full max-w-5xl bg-white/40 rounded-[2rem] md:rounded-[3rem] p-2 md:p-8 flex flex-col overflow-hidden shadow-2xl border border-white/40">
                                
                                {isAdminAuth && (
                                    <div className="mb-6 flex justify-end px-2">
                                        <button onClick={() => { setEditingBoloData(null); setShowBoloModal(true); }} className="bg-green-600 text-white px-6 py-3 rounded-2xl font-black flex items-center gap-2 hover:bg-green-700 transition-all uppercase tracking-tighter shadow-lg shadow-green-600/20 active:scale-95">
                                            <Icon name="plus" size={18}/> Nou Bolo
                                        </button>
                                    </div>
                                )}

                                <div className="flex-1 overflow-y-auto pr-1 md:pr-3 custom-scrollbar space-y-8 md:y-12 pb-32">
                                    <section>
                                        <h3 className="text-2xl md:text-4xl font-black mb-4 uppercase border-b border-green-900/10 pb-2 italic tracking-tighter">Propers Bolos</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 px-2">
                                            {futureBolos.map(renderBoloCard)}
                                        </div>
                                    </section>
                                    <section>
                                        <h3 className="text-2xl md:text-4xl font-black mb-4 uppercase border-b border-green-900/10 pb-2 italic tracking-tighter opacity-40">Bolos Passats</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 px-2">
                                            {pastBolos.map(renderBoloCard)}
                                        </div>
                                    </section>
                                </div>
                            </div>
                        </main>
                        {showBoloModal && renderBoloModal()}
                        {showConfigModal && renderConfigModal()}
                    </div>
                );
            }

            const confirmedCount = Object.values(assignments).filter(v => v !== null).length;
            const declinedCount = Object.values(attendance).filter(v => v === 'red').length;
            const watchingCount = Object.values(attendance).filter(v => v === 'blue').length;
            const pendingCount = ALL_PEOPLE.length - confirmedCount - declinedCount - watchingCount;

            const isInfoDisabled = !isAdminAuth && !selectedBolo.info;
            const isCarsDisabled = !isAdminAuth && !boloSettings.carsEnabled;
            const isFoodDisabled = !isAdminAuth && !boloSettings.foodEnabled;

            const renderInstrumentsTab = () => (
                <div className="flex-1 flex flex-row overflow-hidden">
                    <aside className={`w-[110px] md:w-80 bg-white/20 border-r-2 border-white/30 p-2 flex flex-col shrink-0 overflow-y-auto custom-scrollbar`}>
                        <div className="flex flex-col min-h-0 mb-4">
                            <h3 className="text-[12px] md:text-[18px] font-black uppercase mb-1.5 text-center tracking-[0.1em] text-orange-700/60 bg-orange-100/50 py-1 rounded-lg italic shrink-0">Pendents</h3>
                            <div className="flex flex-col gap-1.5 overflow-y-auto custom-scrollbar max-h-[160px] md:max-h-[280px]">
                                {ALL_PEOPLE.filter(p => !assignments[p] && !['red', 'blue'].includes(attendance[p])).map(p => (
                                    <div key={p} draggable onDragStart={e => e.dataTransfer.setData("p", p)} onClick={() => setPersonToMove(p)}
                                        className={`p-2 md:p-4 rounded-xl text-[12px] md:text-[24px] font-black text-center cursor-grab bg-white/40 hover:bg-white shadow-sm shrink-0 ${personToMove === p ? 'person-selected' : ''}`}>{p}</div>
                                ))}
                            </div>
                        </div>
                        <div className="flex flex-col min-h-0 mb-4">
                            <h3 className="text-[12px] md:text-[18px] font-black uppercase mb-1.5 text-center tracking-[0.1em] text-blue-700/60 bg-blue-100/50 py-1 rounded-lg italic shrink-0">Mirar</h3>
                            <div className="flex flex-col gap-1.5 overflow-y-auto custom-scrollbar max-h-[160px] md:max-h-[280px]">
                                {ALL_PEOPLE.filter(p => attendance[p] === 'blue').map(p => (
                                    <div key={p} draggable onDragStart={e => e.dataTransfer.setData("p", p)} onClick={() => setPersonToMove(p)}
                                        className={`p-2 md:p-4 rounded-xl text-[12px] md:text-[24px] font-black text-center cursor-grab bg-blue-100 text-blue-700 hover:bg-blue-200 shadow-sm shrink-0 ${personToMove === p ? 'person-selected' : ''}`}>{p}</div>
                                ))}
                            </div>
                        </div>
                        <div className="flex flex-col min-h-0">
                            <h3 className="text-[12px] md:text-[18px] font-black uppercase mb-1.5 text-center tracking-[0.1em] text-red-700/60 bg-red-100/50 py-1 rounded-lg italic shrink-0">No Puc</h3>
                            <div className="flex flex-col gap-1.5 overflow-y-auto custom-scrollbar max-h-[160px] md:max-h-[280px]">
                                {ALL_PEOPLE.filter(p => attendance[p] === 'red').map(p => (
                                    <div key={p} draggable onDragStart={e => e.dataTransfer.setData("p", p)} onClick={() => setPersonToMove(p)}
                                        className={`p-2 md:p-4 rounded-xl text-[12px] md:text-[24px] font-black text-center cursor-grab bg-red-100 text-red-700 hover:bg-red-200 shadow-sm shrink-0 ${personToMove === p ? 'person-selected' : ''}`}>{p}</div>
                                ))}
                            </div>
                        </div>
                    </aside>
                    <main className="flex-1 p-2 md:p-4 grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 overflow-y-auto custom-scrollbar content-start pb-4">
                        {INSTRUMENTS.map(inst => (
                            <div key={inst} onDragOver={e=>e.preventDefault()} onDrop={e => {
                                const p = e.dataTransfer.getData("p");
                                syncBoloData({ assignments: { ...assignments, [p]: inst }, attendance: { ...attendance, [p]: 'green' } });
                            }} onClick={() => personToMove && syncBoloData({ assignments: { ...assignments, [personToMove]: inst }, attendance: { ...attendance, [personToMove]: 'green' } })}
                                className="bg-white/40 rounded-xl md:rounded-[2rem] p-2 md:p-4 border border-white/40 shadow-inner h-[120px] md:h-auto">
                                <h3 className="text-[14px] md:text-[16px] font-black uppercase mb-1 border-b-2 border-green-900/10 italic">{inst}</h3>
                                <div className="flex-wrap gap-1 flex">
                                    {ALL_PEOPLE.filter(p => assignments[p] === inst).map(p => (
                                        <span key={p} draggable onDragStart={e => e.dataTransfer.setData("p", p)} onClick={(e) => {e.stopPropagation(); setPersonToMove(p);}}
                                            className={`text-[12px] md:text-[24px] font-black text-green-700 cursor-grab ${personToMove === p ? 'person-selected' : ''}`}>{p}</span>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </main>
                </div>
            );

            const renderInfoTab = () => (
                <div className="flex-1 p-4 md:p-8 flex flex-col overflow-hidden">
                    <h3 className="text-2xl font-black uppercase italic mb-4">Informació Extra</h3>
                    {isAdminAuth ? (
                        <textarea className="flex-1 w-full p-6 bg-white/70 rounded-3xl border-2 border-transparent focus:border-blue-500 outline-none font-bold text-lg md:text-xl resize-none shadow-xl mb-64"
                            placeholder="Afegeix aquí informació sobre el bolo..."
                            defaultValue={selectedBolo.info}
                            onBlur={async (e) => {
                                const newVal = e.target.value;
                                await fb.updateDoc(fb.doc(fb.db, 'artifacts', window.PROD_APP_ID, 'public', 'data', 'bolos', selectedBolo.id), { info: newVal });
                                setSelectedBolo({...selectedBolo, info: newVal});
                            }} />
                    ) : (
                        <div className="flex-1 p-6 bg-white/70 rounded-3xl font-bold text-lg md:text-xl whitespace-pre-wrap shadow-xl overflow-y-auto custom-scrollbar pb-64">
                            {selectedBolo.info || "No hi ha informació addicional disponible."}
                            <div className="h-64 w-full"></div> 
                        </div>
                    )}
                </div>
            );

            const renderCarCostsTable = () => {
                if (!isAdminAuth && !carCosts.enabled) return null;

                const distanciaNum = Number(carCosts.distancia) || 0;
                const consumNum = Number(carCosts.consum) || 0;
                const preuLitreNum = Number(carCosts.preuLitre) || 0;
                const propostaNum = Number(carCosts.proposta) || 0;

                const distanciaTotal = distanciaNum * 2;
                const costGasolinaCotxe = Math.floor((consumNum * preuLitreNum / 100) * distanciaTotal);
                
                const totalCotxesNum = carData.filter(c => c.driver).length;
                const totalMembresNum = carData.reduce((acc, c) => acc + (c.driver ? 1 : 0) + c.passengers.length, 0);

                const totalCostCotxesNum = costGasolinaCotxe * totalCotxesNum;
                // Use total costs divided by total members as logically requested
                const costPerMembreNum = totalMembresNum > 0 ? (totalCostCotxesNum / totalMembresNum) : 0;
                const totalAportatNum = propostaNum * totalMembresNum;
                const aportacioBatucadaNum = totalCostCotxesNum - totalAportatNum;

                return (
                    <div className="mt-8 bg-white/60 p-4 md:p-6 rounded-3xl shadow-md border border-white/40">
                        <div className="flex justify-between items-center mb-5">
                            <h3 className="text-lg md:text-xl font-black uppercase italic text-amber-900">Costos de Desplaçament</h3>
                            {isAdminAuth && (
                                <div className="flex items-center gap-2">
                                    <span className="text-[10px] md:text-xs font-black uppercase opacity-60">Visible Usuaris:</span>
                                    <button 
                                        onClick={() => syncBoloData({ carCosts: { ...carCosts, enabled: !carCosts.enabled } })}
                                        className={`px-3 py-1.5 rounded-lg font-black text-xs uppercase transition-all shadow-sm ${carCosts.enabled ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}
                                    >
                                        {carCosts.enabled ? 'ON' : 'OFF'}
                                    </button>
                                </div>
                            )}
                        </div>
                        
                        <div className="space-y-2 text-[13px] md:text-sm font-bold text-amber-950/80">
                            <div className="flex justify-between items-center bg-white/50 p-2.5 rounded-xl">
                                <span>Distància BOLO Gelida-Destí:</span>
                                <div className="flex items-center gap-1.5">
                                    {isAdminAuth ? (
                                        <input type="number" value={carCosts.distancia} onChange={e => syncBoloData({ carCosts: { ...carCosts, distancia: e.target.value } })} className="w-16 md:w-20 p-1.5 text-right bg-white rounded-lg border border-amber-200 focus:outline-none focus:border-amber-500 font-black text-amber-900" />
                                    ) : (
                                        <span className="font-black text-amber-900">{carCosts.distancia}</span>
                                    )}
                                    <span className="font-black">Kms</span>
                                </div>
                            </div>
                            
                            <div className="flex justify-between items-center bg-white/40 p-2.5 rounded-xl opacity-80">
                                <span>Distància total ANADA-TORNADA:</span>
                                <span className="font-black text-amber-900">{distanciaTotal} Kms</span>
                            </div>
                            
                            <div className="flex justify-between items-center bg-white/50 p-2.5 rounded-xl">
                                <span>Consum mig per cotxe:</span>
                                <div className="flex items-center gap-1.5">
                                    {isAdminAuth ? (
                                        <input type="number" step="0.1" value={carCosts.consum} onChange={e => syncBoloData({ carCosts: { ...carCosts, consum: e.target.value } })} className="w-16 md:w-20 p-1.5 text-right bg-white rounded-lg border border-amber-200 focus:outline-none focus:border-amber-500 font-black text-amber-900" />
                                    ) : (
                                        <span className="font-black text-amber-900">{carCosts.consum}</span>
                                    )}
                                    <span className="font-black">litres/100</span>
                                </div>
                            </div>
                            
                            <div className="flex justify-between items-center bg-white/50 p-2.5 rounded-xl">
                                <span>Preu mig el litre:</span>
                                <div className="flex items-center gap-1.5">
                                    {isAdminAuth ? (
                                        <input type="number" step="0.01" value={carCosts.preuLitre} onChange={e => syncBoloData({ carCosts: { ...carCosts, preuLitre: e.target.value } })} className="w-16 md:w-20 p-1.5 text-right bg-white rounded-lg border border-amber-200 focus:outline-none focus:border-amber-500 font-black text-amber-900" />
                                    ) : (
                                        <span className="font-black text-amber-900">{preuLitreNum.toFixed(2)}</span>
                                    )}
                                    <span className="font-black">€</span>
                                </div>
                            </div>
                            
                            <div className="flex justify-between items-center bg-amber-200/50 p-3 rounded-xl font-black text-amber-900 border border-amber-300">
                                <span>Cost Gasolina per cotxe (aprox):</span>
                                <span>{costGasolinaCotxe} €</span>
                            </div>
                            
                            <div className="h-2"></div>
                            
                            <div className="flex justify-between items-center bg-white/50 p-2.5 rounded-xl">
                                <span>Total Cotxes al bolo:</span>
                                <span className="font-black text-amber-900">{totalCotxesNum}</span>
                            </div>
                            
                            <div className="flex justify-between items-center bg-white/50 p-2.5 rounded-xl">
                                <span>Membres al bolo:</span>
                                <span className="font-black text-amber-900">{totalMembresNum}</span>
                            </div>
                            
                            <div className="flex justify-between items-center bg-white/50 p-2.5 rounded-xl">
                                <span>Cost per membre:</span>
                                <span className="font-black text-amber-900">{costPerMembreNum.toFixed(2)} €</span>
                            </div>
                            
                            <div className="flex justify-between items-center bg-amber-200/50 p-3 rounded-xl font-black text-amber-900 border border-amber-300 my-2 shadow-sm">
                                <span>PROPOSTA per membre pel bolo:</span>
                                <div className="flex items-center gap-1.5">
                                    {isAdminAuth ? (
                                        <input type="number" step="0.1" value={carCosts.proposta} onChange={e => syncBoloData({ carCosts: { ...carCosts, proposta: e.target.value } })} className="w-16 md:w-20 p-1.5 text-right bg-white rounded-lg border border-amber-400 focus:outline-none focus:border-amber-600 font-black text-amber-900 shadow-inner" />
                                    ) : (
                                        <span className="font-black text-amber-900">{propostaNum.toFixed(1)}</span>
                                    )}
                                    <span className="font-black">€</span>
                                </div>
                            </div>
                            
                            <div className="h-2"></div>
                            
                            <div className="flex justify-between items-center bg-blue-50/70 p-3 rounded-xl font-black text-blue-900 border border-blue-200">
                                <span>Total aportat Membres:</span>
                                <span>{totalAportatNum.toFixed(1)} €</span>
                            </div>
                            
                            <div className="flex justify-between items-center bg-red-50/70 p-3 rounded-xl font-black text-red-900 border border-red-200">
                                <span>Total cost tots els cotxes:</span>
                                <span>{totalCostCotxesNum.toFixed(1)} €</span>
                            </div>
                            
                            <div className="flex justify-between items-center bg-green-100/70 p-3.5 rounded-xl font-black text-green-900 text-[15px] border border-green-300 mt-2 shadow-sm">
                                <span>Aportació de la Batucada:</span>
                                <span>{aportacioBatucadaNum.toFixed(1)} €</span>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderCarsTab = () => (
                <div className="flex-1 flex flex-row overflow-hidden">
                    <aside className="w-[110px] md:w-80 bg-white/20 border-r-2 border-white/30 p-2 flex flex-col shrink-0 overflow-hidden">
                        <h3 className="text-[12px] md:text-[18px] font-black uppercase mb-1.5 text-center bg-gray-100/50 py-1 rounded-lg italic shrink-0">Qui va (OK/Mirar)</h3>
                        <div className="flex flex-col gap-1.5 overflow-y-auto custom-scrollbar pb-64">
                            {availablePeople.filter(p => !carData.some(c => c.driver === p || c.passengers.includes(p))).map(p => (
                                <div key={p} draggable onDragStart={e => e.dataTransfer.setData("p", p)} onClick={() => setPersonToMove(p)}
                                    className={`p-2 md:p-4 rounded-xl text-[12px] md:text-[24px] font-black text-center cursor-grab bg-white/40 hover:bg-white shadow-sm shrink-0 ${personToMove === p ? 'person-selected' : ''}`}>{p}</div>
                            ))}
                        </div>
                    </aside>
                    <main className="flex-1 p-2 md:p-4 overflow-y-auto custom-scrollbar pb-64">
                        <div className="flex items-center justify-between mb-4 bg-white/40 p-3 rounded-2xl">
                            <h3 className="text-xl font-black uppercase italic text-amber-900">Gestiò de Cotxes</h3>
                            {isAdminAuth && (
                                <button onClick={() => syncBoloData({ boloSettings: { ...boloSettings, carsEnabled: !boloSettings.carsEnabled } })}
                                    className={`px-4 py-2 rounded-xl font-black text-xs uppercase transition-all shadow-sm ${boloSettings.carsEnabled ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
                                    COTXES: {boloSettings.carsEnabled ? 'SI' : 'NO'}
                                </button>
                            )}
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {carData.map((car, idx) => (
                                <div key={car.id} className="bg-white/60 p-4 rounded-3xl shadow-md border border-white/40">
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="flex items-center gap-2 font-black uppercase italic text-sm text-amber-900"><Icon name="car" size={18}/> COTXE {car.id}</div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-[10px] font-black opacity-40">PLACES:</span>
                                            <input type="number" min="1" max="9" className="w-10 bg-black/5 rounded-lg text-center font-black outline-none focus:bg-white transition-colors" value={car.capacity} 
                                                onChange={(e) => {
                                                    const newData = [...carData];
                                                    newData[idx].capacity = parseInt(e.target.value) || 1;
                                                    syncBoloData({ carData: newData });
                                                }} />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="space-y-1">
                                            <div className="text-[9px] font-black uppercase opacity-50">Conductor:</div>
                                            <div onDragOver={e=>e.preventDefault()} onDrop={e => {
                                                const p = e.dataTransfer.getData("p");
                                                const newData = carData.map(c => ({...c, driver: c.driver === p ? null : c.driver, passengers: c.passengers.filter(pass => pass !== p)}));
                                                newData[idx].driver = p;
                                                syncBoloData({ carData: newData });
                                            }} onClick={() => {
                                                if (personToMove) {
                                                    const newData = carData.map(c => ({...c, driver: c.driver === personToMove ? null : c.driver, passengers: c.passengers.filter(pass => pass !== personToMove)}));
                                                    newData[idx].driver = personToMove;
                                                    syncBoloData({ carData: newData });
                                                    setPersonToMove(null);
                                                } else if (car.driver) {
                                                    const newData = [...carData];
                                                    newData[idx].driver = null;
                                                    syncBoloData({ carData: newData });
                                                }
                                            }}
                                            className="min-h-[40px] bg-white/80 rounded-xl p-2 border-2 border-dashed border-amber-200 flex items-center justify-center font-black text-amber-900 text-sm cursor-pointer hover:bg-white">{car.driver || "BUIT"}</div>
                                        </div>
                                        <div className="space-y-1">
                                            <div className="text-[9px] font-black uppercase opacity-50">Passatgers ({car.passengers.length}/{car.capacity - 1}):</div>
                                            <div onDragOver={e=>e.preventDefault()} onDrop={e => {
                                                const p = e.dataTransfer.getData("p");
                                                if (car.passengers.length >= car.capacity - 1 || car.driver === p) return;
                                                const newData = carData.map(c => ({...c, driver: c.driver === p ? null : c.driver, passengers: c.passengers.filter(pass => pass !== p)}));
                                                newData[idx].passengers.push(p);
                                                syncBoloData({ carData: newData });
                                            }} onClick={() => {
                                                if (!personToMove || car.passengers.length >= car.capacity - 1 || car.driver === personToMove) return;
                                                const newData = carData.map(c => ({...c, driver: c.driver === personToMove ? null : c.driver, passengers: c.passengers.filter(pass => pass !== personToMove)}));
                                                newData[idx].passengers.push(personToMove);
                                                syncBoloData({ carData: newData });
                                                setPersonToMove(null);
                                            }}
                                            className="min-h-[40px] bg-white/80 rounded-xl p-2 border-2 border-dashed border-amber-100 flex flex-wrap gap-1 content-start font-black text-xs text-amber-800/70">
                                                {car.passengers.map(p => (
                                                    <span key={p} className="bg-amber-50 px-1 rounded cursor-pointer hover:bg-red-100 transition-colors" onClick={(e) => {
                                                        e.stopPropagation();
                                                        const newData = [...carData];
                                                        newData[idx].passengers = newData[idx].passengers.filter(pass => pass !== p);
                                                        syncBoloData({ carData: newData });
                                                    }}>{p}</span>
                                                ))}
                                                {car.passengers.length === 0 && car.capacity > 1 && "LLIURE"}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        {renderCarCostsTable()}
                    </main>
                </div>
            );

            const renderFoodTab = () => (
                <div className="flex-1 flex flex-row overflow-hidden">
                    <aside className="w-[110px] md:w-80 bg-white/20 border-r-2 border-white/30 p-2 flex flex-col shrink-0 overflow-hidden">
                        <h3 className="text-[12px] md:text-[18px] font-black uppercase mb-1.5 text-center bg-gray-100/50 py-1 rounded-lg italic shrink-0">NO Menjo</h3>
                        <div className="flex flex-col gap-1.5 overflow-y-auto custom-scrollbar pb-64">
                            {availablePeople.filter(p => !foodData.standard.includes(p) && !foodData.vegan.includes(p) && !foodData.glutenFree.includes(p) && !foodData.glutenFreeVegan.includes(p)).map(p => (
                                <div key={p} draggable onDragStart={e => e.dataTransfer.setData("p", p)} onClick={() => setPersonToMove(p)}
                                    className={`p-2 md:p-4 rounded-xl text-[12px] md:text-[24px] font-black text-center cursor-grab bg-white/40 hover:bg-white shadow-sm shrink-0 ${personToMove === p ? 'person-selected' : ''}`}>{p}</div>
                            ))}
                        </div>
                    </aside>
                    <main className="flex-1 p-2 md:p-4 overflow-y-auto custom-scrollbar pb-64">
                        <div className="flex items-center justify-between mb-4 bg-white/40 p-3 rounded-2xl">
                            <h3 className="text-xl font-black uppercase italic text-purple-900">Gestiò de Menjar</h3>
                            {isAdminAuth && (
                                <button onClick={() => syncBoloData({ boloSettings: { ...boloSettings, foodEnabled: !boloSettings.foodEnabled } })}
                                    className={`px-4 py-2 rounded-xl font-black text-xs uppercase transition-all shadow-sm ${boloSettings.foodEnabled ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
                                    MENJAR: {boloSettings.foodEnabled ? 'SI' : 'NO'}
                                </button>
                            )}
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {[
                                { id: 'standard', label: 'MENJAR ESTÀNDARD', color: 'purple', icon: 'utensils' },
                                { id: 'vegan', label: 'VEGÀ / VEGETARIÀ', color: 'green', icon: 'utensils' },
                                { id: 'glutenFree', label: 'SENSE GLUTEN', color: 'blue', icon: 'utensils' },
                                { id: 'glutenFreeVegan', label: 'SENSE GLUTEN i VEGÀ/VEGETARIÀ', color: 'teal', icon: 'utensils' }
                            ].map(group => (
                                <div key={group.id} onDragOver={e=>e.preventDefault()} onDrop={e => {
                                    const p = e.dataTransfer.getData("p");
                                    const newFD = { ...foodData };
                                    Object.keys(newFD).forEach(k => newFD[k] = (newFD[k] || []).filter(x => x !== p));
                                    newFD[group.id].push(p);
                                    syncBoloData({ foodData: newFD });
                                }} onClick={() => {
                                    if (!personToMove) return;
                                    const newFD = { ...foodData };
                                    Object.keys(newFD).forEach(k => newFD[k] = (newFD[k] || []).filter(x => x !== personToMove));
                                    if (!newFD[group.id]) newFD[group.id] = [];
                                    newFD[group.id].push(personToMove);
                                    syncBoloData({ foodData: newFD });
                                    setPersonToMove(null);
                                }}
                                className={`bg-white/60 p-6 rounded-3xl shadow-md border border-white/40 min-h-[160px] ${personToMove ? 'ring-4 ring-offset-2 ring-purple-500 cursor-pointer' : ''}`}>
                                    <h4 className={`font-black uppercase italic mb-4 flex items-center gap-2 text-${group.color}-800`}><Icon name={group.icon} size={18}/> {group.label}</h4>
                                    <div className="flex flex-wrap gap-2">
                                        {(foodData[group.id] || []).map(p => (
                                            <span key={p} onClick={(e) => { e.stopPropagation(); syncBoloData({ foodData: { ...foodData, [group.id]: foodData[group.id].filter(x => x !== p) } }); }}
                                                className={`bg-${group.color}-100 text-${group.color}-900 px-3 py-1 rounded-full font-black text-sm md:text-xl cursor-pointer hover:bg-red-100`}>{p}</span>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </main>
                </div>
            );

            return (
                <div className="h-screen w-screen flex flex-col overflow-hidden text-green-950">
                    <header className="bg-white/30 backdrop-blur-md border-b border-white/20 px-3 py-3 md:px-6 md:py-4 shrink-0">
                        <h2 className="text-[22px] md:text-4xl font-black italic leading-none tracking-tighter mb-4">{selectedBolo.nombre}</h2>
                        <div className="flex gap-2 md:gap-4 mb-4">
                            <button onClick={() => setActiveTab('instruments')} className={`flex-1 py-3 md:py-5 rounded-xl md:rounded-2xl font-black uppercase italic tracking-tighter text-[11px] md:text-xl transition-all ${activeTab === 'instruments' ? 'btn-3d-pushed bg-green-500 text-white' : 'btn-3d-raised bg-white text-green-900 hover:bg-green-50'}`}>INSTRUMENTS</button>
                            <button onClick={() => !isInfoDisabled && setActiveTab('info')} className={`flex-1 py-3 md:py-5 rounded-xl md:rounded-2xl font-black uppercase italic tracking-tighter text-[11px] md:text-xl transition-all ${activeTab === 'info' ? 'btn-3d-pushed bg-blue-600 text-white' : 'btn-3d-raised bg-white text-blue-900'} ${isInfoDisabled ? 'opacity-30 pointer-events-none' : ''}`}>INFORMACIÓ</button>
                            <button onClick={() => !isCarsDisabled && setActiveTab('cars')} className={`flex-1 py-3 md:py-5 rounded-xl md:rounded-2xl font-black uppercase italic tracking-tighter text-[11px] md:text-xl transition-all ${activeTab === 'cars' ? 'btn-3d-pushed bg-amber-800 text-white' : 'btn-3d-raised bg-white text-amber-900'} ${isCarsDisabled ? 'opacity-30 pointer-events-none' : ''}`}>COTXES</button>
                            <button onClick={() => !isFoodDisabled && setActiveTab('food')} className={`flex-1 py-3 md:py-5 rounded-xl md:rounded-2xl font-black uppercase italic tracking-tighter text-[11px] md:text-xl transition-all ${activeTab === 'food' ? 'btn-3d-pushed bg-purple-600 text-white' : 'btn-3d-raised bg-white text-purple-900'} ${isFoodDisabled ? 'opacity-30 pointer-events-none' : ''}`}>MENJAR</button>
                        </div>
                        <div className="flex items-center justify-between w-full gap-2">
                            <div className="flex items-center bg-black/5 rounded-xl p-1.5 md:px-6 md:py-3 gap-1 md:gap-6 flex-1 justify-between items-stretch">
                                <div className="text-center flex-1 flex flex-col justify-center">
                                    <div className="text-xl md:text-2xl font-black leading-none text-green-700">{confirmedCount}</div>
                                    <div className="text-[11px] md:text-base font-black uppercase opacity-50">OK</div>
                                </div>
                                <div className="text-center flex-1 flex flex-col justify-center">
                                    <div className="text-xl md:text-2xl font-black leading-none text-orange-600">{pendingCount}</div>
                                    <div className="text-[11px] md:text-base font-black uppercase opacity-50">?</div>
                                </div>
                                <div className="text-center flex-1 flex flex-col justify-center">
                                    <div className="text-xl md:text-2xl font-black leading-none text-red-600">{declinedCount}</div>
                                    <div className="text-[11px] md:text-base font-black uppercase opacity-50">NO</div>
                                </div>
                                <div className="text-center flex-1 flex flex-col justify-center">
                                    <div className="text-xl md:text-2xl font-black leading-none text-blue-600">{watchingCount}</div>
                                    <div className="text-[11px] md:text-base font-black uppercase flex items-center justify-center pt-0.5"><Icon name="eye" size={15}/></div>
                                </div>
                            </div>
                            <button onClick={() => { setSelectedBolo(null); setActiveTab('instruments'); setPersonToMove(null); }} className="bg-red-600 text-white px-4 py-2.5 md:px-8 md:py-3 rounded-xl md:rounded-2xl font-black text-[14px] md:text-xl uppercase shadow-xl active:scale-95 transition-all shrink-0">Tornar</button>
                        </div>
                    </header>
                    {isLoading ? <div className="flex-1 flex items-center justify-center"><div className="w-16 h-16 border-4 border-green-600 border-t-transparent rounded-full loading-spin"></div></div> : (
                        <>
                            {activeTab === 'instruments' && renderInstrumentsTab()}
                            {activeTab === 'info' && renderInfoTab()}
                            {activeTab === 'cars' && renderCarsTab()}
                            {activeTab === 'food' && renderFoodTab()}
                        </>
                    )}
                    {personToMove && (
                        <div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-[100] bg-green-700 text-white p-4 rounded-3xl shadow-2xl flex flex-col items-center gap-2 animate-in slide-in-from-bottom-full max-w-[95vw]">
                            <span className="font-black text-xs uppercase opacity-80 italic">Assignant {personToMove}</span>
                            <div className="flex flex-wrap justify-center gap-2">
                                {activeTab === 'food' ? (
                                    <>
                                        {[
                                            { id: 'standard', label: 'EST.', color: 'purple' },
                                            { id: 'vegan', label: 'VEG.', color: 'green' },
                                            { id: 'glutenFree', label: 'GLUT.', color: 'blue' },
                                            { id: 'glutenFreeVegan', label: 'G+V', color: 'teal' }
                                        ].map(group => (
                                            <button key={group.id} onClick={() => {
                                                const newFD = { ...foodData };
                                                Object.keys(newFD).forEach(k => newFD[k] = (newFD[k] || []).filter(x => x !== personToMove));
                                                newFD[group.id].push(personToMove);
                                                syncBoloData({ foodData: newFD });
                                                setPersonToMove(null);
                                            }} className={`bg-${group.color}-600 px-3 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg`}>{group.label}</button>
                                        ))}
                                        <button onClick={() => {
                                            const newFD = { ...foodData };
                                            Object.keys(newFD).forEach(k => newFD[k] = (newFD[k] || []).filter(x => x !== personToMove));
                                            syncBoloData({ foodData: newFD });
                                            setPersonToMove(null);
                                        }} className="bg-gray-600 px-3 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg">No Menjo</button>
                                        <button onClick={() => setPersonToMove(null)} className="bg-black/40 px-3 py-2 rounded-xl font-black text-[10px] uppercase">Anul·lar</button>
                                    </>
                                ) : activeTab === 'cars' ? (
                                    <div className="flex flex-col items-center gap-2">
                                        <span className="text-[14px] font-black text-center mb-1">Seleccionar com a conductor o passatger</span>
                                        <button onClick={() => setPersonToMove(null)} className="bg-black/40 px-3 py-2 rounded-xl font-black text-[10px] uppercase">Anul·lar</button>
                                    </div>
                                ) : (
                                    <>
                                        <button onClick={() => { syncBoloData({ attendance: { ...attendance, [personToMove]: 'blue' }, assignments: { ...assignments, [personToMove]: null } }); setPersonToMove(null); }} className="bg-blue-600 px-3 py-2 rounded-xl font-black text-[10px] uppercase">Mirar</button>
                                        <button onClick={() => { syncBoloData({ attendance: { ...attendance, [personToMove]: 'red' }, assignments: { ...assignments, [personToMove]: null } }); setPersonToMove(null); }} className="bg-red-600 px-3 py-2 rounded-xl font-black text-[10px] uppercase">No Puc</button>
                                        <button onClick={() => setPersonToMove(null)} className="bg-black/40 px-3 py-2 rounded-xl font-black text-[10px] uppercase">Anul·lar</button>
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>