<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tukats - Gestió de Batucada</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel Standalone -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #DCF23A; margin: 0; padding: 0; }
        
        .custom-scrollbar { -webkit-overflow-scrolling: touch; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .person-selected {
            outline: 3px solid #16a34a;
            outline-offset: 2px;
            background-color: white !important;
            z-index: 10;
        }

        /* Efecte 3D Botons Pestanyes */
        .btn-3d-raised {
            box-shadow: 0 4px 0 0 rgba(0,0,0,0.2);
            transform: translateY(-2px);
            transition: all 0.1s ease;
        }
        .btn-3d-pushed {
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.2);
            transform: translateY(2px);
            background-color: rgba(0,0,0,0.05);
        }

        html, body, #root {
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        .overflow-y-auto, .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const productionConfig = {
            apiKey: "AIzaSyAbqfNeh1p-jGp0vGl6K85N-SJSi7DPwn0",
            authDomain: "tukatsbolos.firebaseapp.com",
            projectId: "tukatsbolos",
            storageBucket: "tukatsbolos.firebasestorage.app",
            messagingSenderId: "74618830888",
            appId: "1:74618830888:web:a8e08918d802ab1498751d"
        };

        window.PROD_APP_ID = "tukats-batucada-v1"; 
        let firebaseConfig = productionConfig;
        
        if ((!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("AQUI")) && typeof window.__firebase_config !== 'undefined' && window.__firebase_config) {
            try {
                firebaseConfig = JSON.parse(window.__firebase_config);
                window.PROD_APP_ID = window.__app_id || window.PROD_APP_ID;
            } catch (e) { console.warn("Error config Canvas"); }
        }

        if (firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("AQUI")) {
            const app = initializeApp(firebaseConfig);
            window.FirebaseApp = {
                auth: getAuth(app),
                db: getFirestore(app),
                signInAnonymously,
                signInWithCustomToken,
                onAuthStateChanged,
                doc,
                setDoc,
                onSnapshot,
                updateDoc,
                collection,
                deleteDoc,
                addDoc,
                initialized: true
            };
        } else { window.FirebaseApp = { initialized: false }; }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icon = ({ name, size = 16, className = "" }) => {
            const icons = {
                plus: <path d="M12 5v14M5 12h14" />,
                'log-out': <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />,
                calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></>,
                'map-pin': <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>,
                clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
                hourglass: <><path d="M5 2h14M5 22h14M15 2v5l-3 3-3-3V2M9 22v-5l3-3 3 3v5"/></>,
                key: <><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.778-7.778Zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3-3.5 3.5Z"/></>,
                eye: <><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>,
                info: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>,
                car: <><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></>,
                utensils: <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" />
            };
            return (
                <svg viewBox="0 0 24 24" width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || null}
                </svg>
            );
        };

        const ALL_PEOPLE = ["Jesus", "Merche", "Txis", "Josep", "Nacho", "Mon", "Claudia", "Toñi", "Alba", "Viñet", "Evelyn", "Dahna", "DavidB", "David", "Xavi", "Johny", "Valentin", "JosepA", "Merce", "Lorena", "Bruna", "Emily", "Valentina", "Carmen", "Maria", "Marta", "Paula", "Ona", "Aina", "Lluis", "Ernest"].sort();
        const INSTRUMENTS = ["1a", "2a", "3a", "Caixa", "Timba", "Xapa", "Tamborin", "Repe"];

        function App() {
            const [fb, setFb] = useState(null);
            const [user, setUser] = useState(null);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [isAdminAuth, setIsAdminAuth] = useState(false);
            const [isAdminMode, setIsAdminMode] = useState(false);
            const [passwordInput, setPasswordInput] = useState("");
            const [bolos, setBolos] = useState([]);
            const [selectedBolo, setSelectedBolo] = useState(null);
            const [activeTab, setActiveTab] = useState('instruments');
            
            // Bolo Data State
            const [attendance, setAttendance] = useState({});
            const [assignments, setAssignments] = useState({});
            const [carData, setCarData] = useState(Array.from({length: 8}, (_, i) => ({ id: i+1, driver: null, capacity: 4, passengers: [] })));
            const [foodData, setFoodData] = useState({ standard: [], vegan: [], glutenFree: [], glutenFreeVegan: [] });
            const [boloSettings, setBoloSettings] = useState({ carsEnabled: false, foodEnabled: false });
            
            const [settings, setSettings] = useState({ userPass: "TUKATS", adminPass: "ADMIN" });
            const [isLoading, setIsLoading] = useState(true);
            const [personToMove, setPersonToMove] = useState(null);

            useEffect(() => {
                const interval = setInterval(() => {
                    if (window.FirebaseApp) { setFb(window.FirebaseApp); clearInterval(interval); }
                }, 100);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                if (!fb) return;
                const initAuth = async () => {
                    try {
                        if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                            await fb.signInWithCustomToken(fb.auth, window.__initial_auth_token).catch(() => fb.signInAnonymously(fb.auth));
                        } else { 
                            await fb.signInAnonymously(fb.auth); 
                        }
                    } catch (err) {
                        console.error("Auth init failed, retrying anonymous...");
                        await fb.signInAnonymously(fb.auth);
                    }
                };
                initAuth();
                return fb.onAuthStateChanged(fb.auth, setUser);
            }, [fb]);

            useEffect(() => {
                if (!user || !fb) return;
                const appId = window.PROD_APP_ID;
                const unsubSettings = fb.onSnapshot(fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'app_settings', 'config'), snap => {
                    if (snap.exists()) setSettings(snap.data());
                });
                const unsubBolos = fb.onSnapshot(fb.collection(fb.db, 'artifacts', appId, 'public', 'data', 'bolos'), snap => {
                    setBolos(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => { unsubSettings(); unsubBolos(); };
            }, [user, fb]);

            useEffect(() => {
                if (!user || !selectedBolo || !fb) return;
                setIsLoading(true);
                const appId = window.PROD_APP_ID;
                const unsub = fb.onSnapshot(fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'bolos_attendance', selectedBolo.id), snap => {
                    if (snap.exists()) {
                        const d = snap.data();
                        setAttendance(d.attendance || {});
                        setAssignments(d.assignments || {});
                        setCarData(d.carData || Array.from({length: 8}, (_, i) => ({ id: i+1, driver: null, capacity: 4, passengers: [] })));
                        
                        // FIX: Merge incoming food data with defaults to avoid undefined map error
                        const fd = d.foodData || {};
                        setFoodData({
                            standard: fd.standard || [],
                            vegan: fd.vegan || [],
                            glutenFree: fd.glutenFree || [],
                            glutenFreeVegan: fd.glutenFreeVegan || []
                        });
                        
                        setBoloSettings(d.boloSettings || { carsEnabled: false, foodEnabled: false });
                    }
                    setIsLoading(false);
                }, (err) => { console.error(err); setIsLoading(false); });
                return () => unsub();
            }, [user, selectedBolo, fb]);

            const syncBoloData = async (updates) => {
                if (!user || !selectedBolo || !fb) return;
                const appId = window.PROD_APP_ID;
                const docRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'bolos_attendance', selectedBolo.id);
                const boloRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'bolos', selectedBolo.id);
                
                const finalAtt = updates.attendance || attendance;
                const finalAss = updates.assignments || assignments;
                const finalSettings = updates.boloSettings || boloSettings;

                const counts = {
                    memberCount: Object.values(finalAss).filter(v => v !== null).length,
                    declinedCount: Object.values(finalAtt).filter(v => v === 'red').length,
                    watchingCount: Object.values(finalAtt).filter(v => v === 'blue').length,
                };
                counts.pendingCount = ALL_PEOPLE.length - counts.memberCount - counts.declinedCount - counts.watchingCount;

                try {
                    await fb.updateDoc(docRef, { 
                        attendance: finalAtt, 
                        assignments: finalAss,
                        carData: updates.carData || carData,
                        foodData: updates.foodData || foodData,
                        boloSettings: finalSettings
                    });
                    await fb.updateDoc(boloRef, {
                        ...counts,
                        carsEnabled: !!finalSettings.carsEnabled,
                        foodEnabled: !!finalSettings.foodEnabled
                    });
                } catch (e) { console.error(e); }
            };

            const getBoloDateTime = (b) => {
                if (!b.fecha) return new Date(0);
                const [y, m, d] = b.fecha.split('-').map(Number);
                const [hh, mm] = (b.hora || "00:00").split(':').map(Number);
                return new Date(y, m - 1, d, hh, mm);
            };

            const esPasado = (b) => {
                const fechaBolo = getBoloDateTime(b);
                return fechaBolo < new Date();
            };

            const handleLogin = (e) => {
                e.preventDefault();
                const target = isAdminMode ? settings.adminPass : settings.userPass;
                if (passwordInput === target) {
                    setIsLoggedIn(true);
                    setIsAdminAuth(isAdminMode);
                    setPasswordInput("");
                }
            };

            const availablePeople = useMemo(() => {
                return ALL_PEOPLE.filter(p => attendance[p] === 'green' || attendance[p] === 'blue' || assignments[p] !== null);
            }, [attendance, assignments]);

            const renderBoloCard = (b) => {
                const hasInfo = b.info && b.info.trim().length > 0;
                
                return (
                    <div key={b.id} onClick={() => { setSelectedBolo(b); setActiveTab('instruments'); }} 
                         className="p-4 bg-white/70 rounded-3xl flex flex-col gap-3 shadow-md hover:border-green-500 border-2 border-transparent transition-all cursor-pointer">
                        <h4 className="text-2xl font-black italic text-green-900 uppercase leading-none">{b.nombre}</h4>
                        <div className="flex flex-col gap-1 text-[13px] font-black opacity-60 uppercase tracking-wider">
                            <div className="flex gap-3">
                                <span className="flex items-center gap-1"><Icon name="calendar" size={14}/> {b.fecha}</span>
                                <span className="flex items-center gap-1"><Icon name="clock" size={14}/> {b.hora}</span>
                            </div>
                            <span className="flex items-center gap-1"><Icon name="map-pin" size={14}/> {b.lugar}</span>
                        </div>
                        
                        <div className="flex flex-col gap-1.5 mt-1">
                            <div className="flex gap-1 w-full">
                                <div className="flex-1 bg-green-100 text-green-800 p-2 rounded-xl text-center font-black text-[10px] uppercase">{b.memberCount || 0} OK</div>
                                <div className="flex-1 bg-orange-100 text-orange-800 p-2 rounded-xl text-center font-black text-[10px] uppercase">{b.pendingCount || 0} ?</div>
                                <div className="flex-1 bg-red-100 text-red-800 p-2 rounded-xl text-center font-black text-[10px] uppercase">{b.declinedCount || 0} NO</div>
                                <div className="flex-1 bg-blue-100 text-blue-800 p-2 rounded-xl text-center font-black text-[10px] uppercase flex items-center justify-center gap-1">
                                    <Icon name="eye" size={10}/> {b.watchingCount || 0}
                                </div>
                            </div>
                            
                            <div className="flex gap-1 w-full">
                                <div className={`flex-1 p-2 rounded-xl text-center font-black text-[10px] uppercase flex items-center justify-center gap-1 transition-all ${hasInfo ? 'bg-blue-600 text-white shadow-md' : 'bg-blue-600/5 text-blue-900/10'}`}>
                                    <Icon name="info" size={10}/> INFO
                                </div>
                                <div className={`flex-1 p-2 rounded-xl text-center font-black text-[10px] uppercase flex items-center justify-center gap-1 transition-all ${b.carsEnabled ? 'bg-amber-800 text-white shadow-md' : 'bg-amber-800/5 text-amber-900/10'}`}>
                                    <Icon name="car" size={10}/> COTXES
                                </div>
                                <div className={`flex-1 p-2 rounded-xl text-center font-black text-[10px] uppercase flex items-center justify-center gap-1 transition-all ${b.foodEnabled ? 'bg-purple-600 text-white shadow-md' : 'bg-purple-600/5 text-purple-900/10'}`}>
                                    <Icon name="utensils" size={10}/> MENJAR
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderInstrumentsTab = () => (
                <div className="flex-1 flex flex-row overflow-hidden">
                    <aside className={`w-[110px] md:w-80 bg-white/20 border-r-2 border-white/30 p-2 flex flex-col shrink-0 overflow-hidden`}>
                        <div className="flex flex-col min-h-0">
                            <h3 className="text-[12px] md:text-[18px] font-black uppercase mb-1.5 text-center tracking-[0.1em] text-orange-700/60 bg-orange-100/50 py-1 rounded-lg italic">Pendents</h3>
                            <div className="flex-1 flex flex-col gap-1.5 overflow-y-auto custom-scrollbar pb-2">
                                {ALL_PEOPLE.filter(p => !assignments[p] && !['red', 'blue'].includes(attendance[p])).map(p => (
                                    <div key={p} draggable onDragStart={e => e.dataTransfer.setData("p", p)} onClick={() => setPersonToMove(p)}
                                        className={`p-2 md:p-4 rounded-xl text-[12px] md:text-[24px] font-black text-center cursor-grab bg-white/40 hover:bg-white shadow-sm ${personToMove === p ? 'person-selected' : ''}`}>{p}</div>
                                ))}
                            </div>
                        </div>
                        <div className="flex flex-col mt-3 min-h-0">
                            <h3 className="text-[12px] md:text-[18px] font-black uppercase mb-1.5 text-center tracking-[0.1em] text-blue-700/60 bg-blue-100/50 py-1 rounded-lg italic">Mirar</h3>
                            <div className="flex-1 flex flex-col gap-1.5 overflow-y-auto custom-scrollbar pb-2">
                                {ALL_PEOPLE.filter(p => attendance[p] === 'blue').map(p => (
                                    <div key={p} draggable onDragStart={e => e.dataTransfer.setData("p", p)} onClick={() => setPersonToMove(p)}
                                        className={`p-2 md:p-4 rounded-xl text-[12px] md:text-[24px] font-black text-center cursor-grab bg-blue-100 text-blue-700 hover:bg-blue-200 shadow-sm ${personToMove === p ? 'person-selected' : ''}`}>{p}</div>
                                ))}
                            </div>
                        </div>
                    </aside>
                    <main className="flex-1 p-2 md:p-4 grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 overflow-y-auto custom-scrollbar content-start">
                        {INSTRUMENTS.map(inst => (
                            <div key={inst} onDragOver={e=>e.preventDefault()} onDrop={e => {
                                const p = e.dataTransfer.getData("p");
                                syncBoloData({ assignments: { ...assignments, [p]: inst }, attendance: { ...attendance, [p]: 'green' } });
                            }} onClick={() => personToMove && syncBoloData({ assignments: { ...assignments, [personToMove]: inst }, attendance: { ...attendance, [personToMove]: 'green' } })}
                                className="bg-white/40 rounded-xl md:rounded-[2rem] p-2 md:p-4 border border-white/40 shadow-inner h-[120px] md:h-auto">
                                <h3 className="text-[14px] md:text-[16px] font-black uppercase mb-1 border-b-2 border-green-900/10 italic">{inst}</h3>
                                <div className="flex-wrap gap-1 flex">
                                    {ALL_PEOPLE.filter(p => assignments[p] === inst).map(p => (
                                        <span key={p} draggable onDragStart={e => e.dataTransfer.setData("p", p)} onClick={(e) => {e.stopPropagation(); setPersonToMove(p);}}
                                            className={`text-[12px] md:text-[24px] font-black text-green-700 cursor-grab ${personToMove === p ? 'person-selected' : ''}`}>{p}</span>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </main>
                </div>
            );

            const renderInfoTab = () => (
                <div className="flex-1 p-4 md:p-8 flex flex-col overflow-hidden">
                    <h3 className="text-2xl font-black uppercase italic mb-4">Informació Extra</h3>
                    {isAdminAuth ? (
                        <textarea className="flex-1 w-full p-6 bg-white/70 rounded-3xl border-2 border-transparent focus:border-blue-500 outline-none font-bold text-lg md:text-xl resize-none shadow-xl"
                            placeholder="Afegeix aquí informació sobre el bolo..."
                            defaultValue={selectedBolo.info}
                            onBlur={async (e) => {
                                const newVal = e.target.value;
                                await fb.updateDoc(fb.doc(fb.db, 'artifacts', window.PROD_APP_ID, 'public', 'data', 'bolos', selectedBolo.id), { info: newVal });
                                setSelectedBolo({...selectedBolo, info: newVal});
                            }} />
                    ) : (
                        <div className="flex-1 p-6 bg-white/70 rounded-3xl font-bold text-lg md:text-xl whitespace-pre-wrap shadow-xl overflow-y-auto custom-scrollbar">
                            {selectedBolo.info || "No hi ha informació addicional disponible."}
                        </div>
                    )}
                </div>
            );

            const renderCarsTab = () => (
                <div className="flex-1 flex flex-row overflow-hidden">
                    <aside className="w-[110px] md:w-80 bg-white/20 border-r-2 border-white/30 p-2 flex flex-col shrink-0 overflow-hidden">
                        <h3 className="text-[12px] md:text-[18px] font-black uppercase mb-1.5 text-center bg-gray-100/50 py-1 rounded-lg italic">Qui va (OK/Mirar)</h3>
                        <div className="flex flex-col gap-1.5 overflow-y-auto custom-scrollbar">
                            {availablePeople.filter(p => !carData.some(c => c.driver === p || c.passengers.includes(p))).map(p => (
                                <div key={p} draggable onDragStart={e => e.dataTransfer.setData("p", p)} onClick={() => setPersonToMove(p)}
                                    className={`p-2 md:p-4 rounded-xl text-[12px] md:text-[24px] font-black text-center cursor-grab bg-white/40 hover:bg-white shadow-sm ${personToMove === p ? 'person-selected' : ''}`}>{p}</div>
                            ))}
                        </div>
                    </aside>
                    <main className="flex-1 p-2 md:p-4 overflow-y-auto custom-scrollbar">
                        <div className="flex items-center justify-between mb-4 bg-white/40 p-3 rounded-2xl">
                            <h3 className="text-xl font-black uppercase italic">Gestiò de Cotxes</h3>
                            {isAdminAuth && (
                                <button onClick={() => syncBoloData({ boloSettings: { ...boloSettings, carsEnabled: !boloSettings.carsEnabled } })}
                                    className={`px-4 py-2 rounded-xl font-black text-xs uppercase transition-all ${boloSettings.carsEnabled ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
                                    COTXES: {boloSettings.carsEnabled ? 'SI' : 'NO'}
                                </button>
                            )}
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {carData.map((car, idx) => (
                                <div key={car.id} className="bg-white/60 p-4 rounded-3xl shadow-md border border-white/40">
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="flex items-center gap-2 font-black uppercase italic text-sm text-amber-900"><Icon name="car" size={18}/> COTXE {car.id}</div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-[10px] font-black opacity-40">PLACES:</span>
                                            <input type="number" min="1" max="9" className="w-10 bg-black/5 rounded-lg text-center font-black" value={car.capacity} 
                                                onChange={(e) => {
                                                    const newData = [...carData];
                                                    newData[idx].capacity = parseInt(e.target.value) || 1;
                                                    syncBoloData({ carData: newData });
                                                }} />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="space-y-1">
                                            <div className="text-[9px] font-black uppercase opacity-50">Conductor:</div>
                                            <div onDragOver={e=>e.preventDefault()} onDrop={e => {
                                                const p = e.dataTransfer.getData("p");
                                                const newData = carData.map(c => ({...c, driver: c.driver === p ? null : c.driver, passengers: c.passengers.filter(pass => pass !== p)}));
                                                newData[idx].driver = p;
                                                syncBoloData({ carData: newData });
                                            }} onClick={() => {
                                                if (!personToMove) return;
                                                const newData = carData.map(c => ({...c, driver: c.driver === personToMove ? null : c.driver, passengers: c.passengers.filter(pass => pass !== personToMove)}));
                                                newData[idx].driver = personToMove;
                                                syncBoloData({ carData: newData });
                                                setPersonToMove(null);
                                            }}
                                            className="min-h-[40px] bg-white/80 rounded-xl p-2 border-2 border-dashed border-amber-200 flex items-center justify-center font-black text-amber-900 text-sm">{car.driver || "BUIT"}</div>
                                        </div>
                                        <div className="space-y-1">
                                            <div className="text-[9px] font-black uppercase opacity-50">Passatgers ({car.passengers.length}/{car.capacity - 1}):</div>
                                            <div onDragOver={e=>e.preventDefault()} onDrop={e => {
                                                const p = e.dataTransfer.getData("p");
                                                if (car.passengers.length >= car.capacity - 1 || car.driver === p) return;
                                                const newData = carData.map(c => ({...c, driver: c.driver === p ? null : c.driver, passengers: c.passengers.filter(pass => pass !== p)}));
                                                newData[idx].passengers.push(p);
                                                syncBoloData({ carData: newData });
                                            }} onClick={() => {
                                                if (!personToMove || car.passengers.length >= car.capacity - 1 || car.driver === personToMove) return;
                                                const newData = carData.map(c => ({...c, driver: c.driver === personToMove ? null : c.driver, passengers: c.passengers.filter(pass => pass !== personToMove)}));
                                                newData[idx].passengers.push(personToMove);
                                                syncBoloData({ carData: newData });
                                                setPersonToMove(null);
                                            }}
                                            className="min-h-[40px] bg-white/80 rounded-xl p-2 border-2 border-dashed border-amber-100 flex flex-wrap gap-1 content-start font-black text-xs text-amber-800/70">
                                                {car.passengers.map(p => (
                                                    <span key={p} className="bg-amber-50 px-1 rounded" onClick={(e) => {
                                                        e.stopPropagation();
                                                        const newData = [...carData];
                                                        newData[idx].passengers = newData[idx].passengers.filter(pass => pass !== p);
                                                        syncBoloData({ carData: newData });
                                                    }}>{p}</span>
                                                ))}
                                                {car.passengers.length === 0 && "SENSE PLACES"}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </main>
                </div>
            );

            const renderFoodTab = () => (
                <div className="flex-1 flex flex-row overflow-hidden">
                    <aside className="w-[110px] md:w-80 bg-white/20 border-r-2 border-white/30 p-2 flex flex-col shrink-0 overflow-hidden">
                        <h3 className="text-[12px] md:text-[18px] font-black uppercase mb-1.5 text-center bg-gray-100/50 py-1 rounded-lg italic">NO Menjo</h3>
                        <div className="flex flex-col gap-1.5 overflow-y-auto custom-scrollbar">
                            {availablePeople.filter(p => !foodData.standard.includes(p) && !foodData.vegan.includes(p) && !foodData.glutenFree.includes(p) && !foodData.glutenFreeVegan.includes(p)).map(p => (
                                <div key={p} draggable onDragStart={e => e.dataTransfer.setData("p", p)} onClick={() => setPersonToMove(p)}
                                    className={`p-2 md:p-4 rounded-xl text-[12px] md:text-[24px] font-black text-center cursor-grab bg-white/40 hover:bg-white shadow-sm ${personToMove === p ? 'person-selected' : ''}`}>{p}</div>
                            ))}
                        </div>
                    </aside>
                    <main className="flex-1 p-2 md:p-4 overflow-y-auto custom-scrollbar">
                        <div className="flex items-center justify-between mb-4 bg-white/40 p-3 rounded-2xl">
                            <h3 className="text-xl font-black uppercase italic text-purple-900">Gestiò de Menjar</h3>
                            {isAdminAuth && (
                                <button onClick={() => syncBoloData({ boloSettings: { ...boloSettings, foodEnabled: !boloSettings.foodEnabled } })}
                                    className={`px-4 py-2 rounded-xl font-black text-xs uppercase transition-all ${boloSettings.foodEnabled ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
                                    MENJAR: {boloSettings.foodEnabled ? 'SI' : 'NO'}
                                </button>
                            )}
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {[
                                { id: 'standard', label: 'MENJAR ESTÀNDARD', color: 'purple', icon: 'utensils' },
                                { id: 'vegan', label: 'VEGÀ / VEGETARIÀ', color: 'green', icon: 'utensils' },
                                { id: 'glutenFree', label: 'SENSE GLUTEN', color: 'blue', icon: 'utensils' },
                                { id: 'glutenFreeVegan', label: 'SENSE GLUTEN i VEGÀ/VEGETARIÀ', color: 'teal', icon: 'utensils' }
                            ].map(group => (
                                <div key={group.id} onDragOver={e=>e.preventDefault()} onDrop={e => {
                                    const p = e.dataTransfer.getData("p");
                                    const newFD = { ...foodData };
                                    Object.keys(newFD).forEach(k => newFD[k] = newFD[k].filter(x => x !== p));
                                    newFD[group.id].push(p);
                                    syncBoloData({ foodData: newFD });
                                }} onClick={() => {
                                    if (!personToMove) return;
                                    const newFD = { ...foodData };
                                    Object.keys(newFD).forEach(k => newFD[k] = (newFD[k] || []).filter(x => x !== personToMove));
                                    if (!newFD[group.id]) newFD[group.id] = [];
                                    newFD[group.id].push(personToMove);
                                    syncBoloData({ foodData: newFD });
                                    setPersonToMove(null);
                                }}
                                className={`bg-white/60 p-6 rounded-3xl shadow-md border border-white/40 min-h-[160px] ${personToMove ? 'ring-4 ring-offset-2 ring-purple-500 cursor-pointer' : ''}`}>
                                    <h4 className={`font-black uppercase italic mb-4 flex items-center gap-2 text-${group.color}-800`}><Icon name={group.icon} size={18}/> {group.label}</h4>
                                    <div className="flex flex-wrap gap-2">
                                        {(foodData[group.id] || []).map(p => (
                                            <span key={p} onClick={(e) => { e.stopPropagation(); syncBoloData({ foodData: { ...foodData, [group.id]: foodData[group.id].filter(x => x !== p) } }); }}
                                                className={`bg-${group.color}-100 text-${group.color}-900 px-3 py-1 rounded-full font-black text-sm md:text-xl cursor-pointer hover:bg-red-100`}>{p}</span>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </main>
                </div>
            );

            if (!isLoggedIn) return (
                <div className="h-screen w-screen flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-sm border-t-[10px] border-green-600">
                        <h1 className="text-4xl font-black text-center mb-8 text-green-900 uppercase tracking-tighter italic">Tukats Login</h1>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <div className="flex items-center space-x-3 bg-gray-50 p-4 rounded-2xl border border-gray-100">
                                <input type="checkbox" id="adm" checked={isAdminMode} onChange={e => setIsAdminMode(e.target.checked)} className="w-6 h-6 accent-green-600 cursor-pointer" />
                                <label htmlFor="adm" className="text-sm font-black text-gray-700 cursor-pointer select-none uppercase tracking-tight">Mode Administrador</label>
                            </div>
                            <input type="password" placeholder="Contrasenya" className="w-full p-5 bg-gray-50 border-2 border-transparent rounded-2xl focus:border-green-500 outline-none text-xl font-bold" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} required />
                            <button type="submit" className="w-full bg-green-600 text-white font-black py-5 rounded-2xl hover:bg-green-700 shadow-xl transition-all uppercase tracking-widest text-lg">Entrar</button>
                        </form>
                    </div>
                </div>
            );

            if (!selectedBolo) {
                const sortedBolos = [...bolos].sort((a, b) => getBoloDateTime(a) - getBoloDateTime(b));
                const futureBolos = sortedBolos.filter(b => !esPasado(b));
                const pastBolos = sortedBolos.filter(b => esPasado(b)).reverse();

                return (
                    <div className="h-screen w-screen flex flex-col overflow-hidden text-green-950">
                        <header className="px-6 py-4 bg-white/20 backdrop-blur-md flex justify-between items-center shrink-0 border-b border-white/20">
                            <h2 className="text-2xl font-black italic tracking-tighter uppercase shrink-0">TUKATS - BOLOS</h2>
                            <div className="flex gap-2">
                                <button onClick={() => setIsLoggedIn(false)} className="bg-red-600 text-white px-4 py-2 rounded-xl font-black flex items-center gap-1.5 hover:bg-red-700 uppercase tracking-tighter shadow-md text-xs shrink-0"><Icon name="log-out" size={14}/> Sortir</button>
                            </div>
                        </header>
                        <main className="flex-1 p-2 md:p-8 flex flex-col items-center overflow-hidden">
                            <div className="w-full max-w-5xl bg-white/40 rounded-[2rem] md:rounded-[3rem] p-2 md:p-8 flex flex-col overflow-hidden shadow-2xl border border-white/40">
                                <div className="flex-1 overflow-y-auto pr-1 md:pr-3 custom-scrollbar space-y-8 md:y-12">
                                    <section>
                                        <h3 className="text-2xl md:text-4xl font-black mb-4 uppercase border-b border-green-900/10 pb-2 italic tracking-tighter">Propers Bolos</h3>
                                        <div className="space-y-4">{futureBolos.map(renderBoloCard)}</div>
                                    </section>
                                    <section>
                                        <h3 className="text-2xl md:text-4xl font-black mb-4 uppercase border-b border-green-900/10 pb-2 italic tracking-tighter opacity-40">Bolos Passats</h3>
                                        <div className="space-y-4">{pastBolos.map(renderBoloCard)}</div>
                                    </section>
                                </div>
                            </div>
                        </main>
                    </div>
                );
            }

            const confirmedCount = Object.values(assignments).filter(v => v !== null).length;
            const declinedCount = Object.values(attendance).filter(v => v === 'red').length;
            const watchingCount = Object.values(attendance).filter(v => v === 'blue').length;
            const pendingCount = ALL_PEOPLE.length - confirmedCount - declinedCount - watchingCount;

            const isInfoDisabled = !isAdminAuth && !selectedBolo.info;
            const isCarsDisabled = !isAdminAuth && !boloSettings.carsEnabled;
            const isFoodDisabled = !isAdminAuth && !boloSettings.foodEnabled;

            return (
                <div className="h-screen w-screen flex flex-col overflow-hidden text-green-950">
                    <header className="bg-white/30 backdrop-blur-md border-b border-white/20 px-3 py-3 md:px-6 md:py-4 shrink-0">
                        <h2 className="text-[22px] md:text-4xl font-black uppercase italic leading-none tracking-tighter mb-4">{selectedBolo.nombre}</h2>
                        <div className="flex gap-2 md:gap-4 mb-4">
                            <button onClick={() => setActiveTab('instruments')} className={`flex-1 py-3 md:py-5 rounded-xl md:rounded-2xl font-black uppercase italic tracking-tighter text-[11px] md:text-xl transition-all ${activeTab === 'instruments' ? 'btn-3d-pushed bg-green-500 text-white' : 'btn-3d-raised bg-white text-green-900 hover:bg-green-50'}`}>INSTRUMENTS</button>
                            <button onClick={() => !isInfoDisabled && setActiveTab('info')} className={`flex-1 py-3 md:py-5 rounded-xl md:rounded-2xl font-black uppercase italic tracking-tighter text-[11px] md:text-xl transition-all ${activeTab === 'info' ? 'btn-3d-pushed bg-blue-600 text-white' : 'btn-3d-raised bg-white text-blue-900'} ${isInfoDisabled ? 'opacity-30 pointer-events-none' : ''}`}>INFORMACIÓ</button>
                            <button onClick={() => !isCarsDisabled && setActiveTab('cars')} className={`flex-1 py-3 md:py-5 rounded-xl md:rounded-2xl font-black uppercase italic tracking-tighter text-[11px] md:text-xl transition-all ${activeTab === 'cars' ? 'btn-3d-pushed bg-amber-800 text-white' : 'btn-3d-raised bg-white text-amber-900'} ${isCarsDisabled ? 'opacity-30 pointer-events-none' : ''}`}>COTXES</button>
                            <button onClick={() => !isFoodDisabled && setActiveTab('food')} className={`flex-1 py-3 md:py-5 rounded-xl md:rounded-2xl font-black uppercase italic tracking-tighter text-[11px] md:text-xl transition-all ${activeTab === 'food' ? 'btn-3d-pushed bg-purple-600 text-white' : 'btn-3d-raised bg-white text-purple-900'} ${isFoodDisabled ? 'opacity-30 pointer-events-none' : ''}`}>MENJAR</button>
                        </div>
                        <div className="flex items-center justify-between w-full gap-2">
                            <div className="flex items-center bg-black/5 rounded-xl p-1.5 md:px-6 md:py-3 gap-1 md:gap-6 flex-1 justify-between items-stretch">
                                <div className="text-center flex-1">
                                    <div className="text-xl md:text-2xl font-black leading-none text-green-700">{confirmedCount}</div>
                                    <div className="text-[11px] md:text-base font-black uppercase opacity-50">OK</div>
                                </div>
                                <div className="text-center flex-1">
                                    <div className="text-xl md:text-2xl font-black leading-none text-orange-600">{pendingCount}</div>
                                    <div className="text-[11px] md:text-base font-black uppercase opacity-50">?</div>
                                </div>
                                <div className="text-center flex-1">
                                    <div className="text-xl md:text-2xl font-black leading-none text-red-600">{declinedCount}</div>
                                    <div className="text-[11px] md:text-base font-black uppercase opacity-50">NO</div>
                                </div>
                                <div className="text-center flex-1">
                                    <div className="text-xl md:text-2xl font-black leading-none text-blue-600">{watchingCount}</div>
                                    <div className="text-[11px] md:text-base font-black uppercase flex items-center justify-center pt-0.5"><Icon name="eye" size={15}/></div>
                                </div>
                            </div>
                            <button onClick={() => { setSelectedBolo(null); setActiveTab('instruments'); setPersonToMove(null); }} className="bg-red-600 text-white px-4 py-2.5 md:px-8 md:py-3 rounded-xl md:rounded-2xl font-black text-[14px] md:text-xl uppercase shadow-xl active:scale-95 transition-all shrink-0">Tornar</button>
                        </div>
                    </header>
                    {isLoading ? <div className="flex-1 flex items-center justify-center"><div className="w-16 h-16 border-4 border-green-600 border-t-transparent rounded-full loading-spin"></div></div> : (
                        <>
                            {activeTab === 'instruments' && renderInstrumentsTab()}
                            {activeTab === 'info' && renderInfoTab()}
                            {activeTab === 'cars' && renderCarsTab()}
                            {activeTab === 'food' && renderFoodTab()}
                        </>
                    )}
                    {personToMove && (
                        <div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-[100] bg-green-700 text-white p-4 rounded-3xl shadow-2xl flex flex-col items-center gap-2 animate-in slide-in-from-bottom-full max-w-[95vw]">
                            <span className="font-black text-xs uppercase opacity-80 italic">Assignant {personToMove}</span>
                            <div className="flex flex-wrap justify-center gap-2">
                                {activeTab === 'food' ? (
                                    <>
                                        {[
                                            { id: 'standard', label: 'EST.', color: 'purple' },
                                            { id: 'vegan', label: 'VEG.', color: 'green' },
                                            { id: 'glutenFree', label: 'GLUT.', color: 'blue' },
                                            { id: 'glutenFreeVegan', label: 'G+V', color: 'teal' }
                                        ].map(group => (
                                            <button key={group.id} onClick={() => {
                                                const newFD = { ...foodData };
                                                Object.keys(newFD).forEach(k => newFD[k] = (newFD[k] || []).filter(x => x !== personToMove));
                                                newFD[group.id].push(personToMove);
                                                syncBoloData({ foodData: newFD });
                                                setPersonToMove(null);
                                            }} className={`bg-${group.color}-600 px-3 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg`}>{group.label}</button>
                                        ))}
                                        <button onClick={() => {
                                            const newFD = { ...foodData };
                                            Object.keys(newFD).forEach(k => newFD[k] = (newFD[k] || []).filter(x => x !== personToMove));
                                            syncBoloData({ foodData: newFD });
                                            setPersonToMove(null);
                                        }} className="bg-gray-600 px-3 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg">No Menjo</button>
                                        <button onClick={() => setPersonToMove(null)} className="bg-black/40 px-3 py-2 rounded-xl font-black text-[10px] uppercase">Anul·lar</button>
                                    </>
                                ) : (
                                    <>
                                        <button onClick={() => { syncBoloData({ attendance: { ...attendance, [personToMove]: 'blue' }, assignments: { ...assignments, [personToMove]: null } }); setPersonToMove(null); }} className="bg-blue-600 px-3 py-2 rounded-xl font-black text-[10px] uppercase">Mirar</button>
                                        <button onClick={() => { syncBoloData({ attendance: { ...attendance, [personToMove]: 'red' }, assignments: { ...assignments, [personToMove]: null } }); setPersonToMove(null); }} className="bg-red-600 px-3 py-2 rounded-xl font-black text-[10px] uppercase">No Puc</button>
                                        <button onClick={() => setPersonToMove(null)} className="bg-black/40 px-3 py-2 rounded-xl font-black text-[10px] uppercase">Anul·lar</button>
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>